# Customer_Lifetime_Value_Analysis
This project predicts the customer lifetime value based on the customer purchase behavior. Such application is common in the field of business intelligence

Customer lifetime value (CLV) is the “discounted value of future profits generated by a customer." The type of CLV analysis I did here is predictive CLV, which is to model the purchasing behavior of customers in order to infer what their future actions will be. Whether a predictive CLV model and methodology makes sense for the use case will largely be determined by the business context. Usually the business context is defined along two dimensions: non-contractual vs. contractual business settings, and continuous vs. discrete purchase opportunities. So in total, there are four business settings. They are shown as follows:

//four business setting illustration

In a discrete setting, purchases occur at fixed frequencies. In the continuous setting, on the contrary, purchases can happen at any time. When there is no contract, customers can leave at any time they want. When there is a contract, however, customers should not leave within the effective period of the contract and if they do, they’ll pay a high cost for that. Once it is known in which scenario this problem falls, there are models ready to be used. So the first task is to make sure in which situation this problem falls. 

At first let's decide whether purchases in this dataset are discrete or continuous. To know whether purchases happen at a fixed frequency or not, time intervals between purchases need to be checked. The following figure compares the situation that corresponds to a fixed purchase interval with that which corresponds to a flexible purchase interval:

// fixed_vs_flexible

When the time interval is fixed, the difference between time intervals are basically 0. On the contrary, when the time interval is not fixed, one time interval differs greatly from another. Based on this observation, the average time interval difference is used to determine whether the purchase behavior in this dataset is a continuous one or discrete one. The average time interval difference is calculated as follows:

// APTI(k)

The histogram gives an overall description of the average purchase time interval. However, it is weak in helping make a decision whether purchases behavior in this dataset corresponds to a continuous one or a discrete one. To make a decision on which category this dataset falls, all customers are divided into two groups. Customers whose APTI is greater than 30 are defined to have a flexible purchase behavior. On the contrary, those whose APTI are smaller than 30 are said to have a fixed purchase behavior. In APTI, the number refers to the number of days, so 30 refers to a month. There is no theorem behind why 30 is selected as the threshold. Since there is no background information pertaining to how instable the purchase behaviors should be to be defined as flexible, this threshold is selected based on my common sense. If in practice, there are more background information that help better decide this threshold, a more accurate decision about whether this purchase behavior is flexible or fixed can be made. In this an exercise, 30 is used as a threshold so that we can move forward to the next step of this solution. 

Later the ratio of number of customer in the flexible group to the number of customer in the fixed group is used as continuity index to indicate whether the purchase behavior in this dataset is continuous (flexible) or discrete (fixed). In this dataset, the continuity index is 2.064, which means that there are twice as many customers in the flexible group as in the fixed group. So it is reasonable to categorize customers this dataset into ones that have continuous purchase behavior. 

The next step is to decide whether the scenario in this dataset falls into the contractual setting or non-contractual setting. The following analysis assumes the non-contractual setting for two reasons: (1). there is no contract information related in the background information; (2) the business context of this problem, people buying widgets, is more likely to fall in non-contractual situation than in contractual situation. Summarizing the aforementioned, the business in this dataset is likely to be continuous and non-contractual. The following analysis will be based on this point.

In this project, probabilistic models are used to model the predictive CLV of different customers. Although different probabilistic models make different assumptions on data, all probabilistic models share a similar framework. In this framework, the purchase behavior is characterized by three key parameters: 

1. Lifetime: The period that the customer may purchase the product.

2. Purchase rate: The number of purchases a customer may make in a certain period of time.

3. Monetary value: The expected monetary value of a future transaction.

All probabilistic models assume that those three key latent parameters follow certain probability distributions. The difference among those probabilistic models is that each model has its own assumption of how those three parameters are distributed and how to model the heterogeneity of these three parameters among customers. 

In my solution, the model is selected and validated via cross-validation, which works as follows: At first the data is split into a training set and a validation set. The model only has access to the training set. Its parameters are trained on the training set. After being trained, it makes predictions on the validation set. Those predictions will be compared with the ground truth in the validation set and the difference between the prediction and true labels is used as a metric to show how well this model works. The model that achieves the optimal goodness score will be used as the final model. That final model will be trained on the whole dataset then predict the label in the future. The average absolute difference, in this problem, is used as a goodness score and is defined as follows:

// average_absolute_difference_definition 

It is recommended that the time period for the training data should include at least 3 times the typical inter-purchase time of the customers. Since the inter-purchase time is assumed to have an exponential distribution, the “typical” inter-purchase time should be the expectation of the distribution. Using the maximum likelihood estimation, the expectation of the exponential distribution, when estimated from data, is the mean of the sample. In this dataset, the sample mean is 52.231 and there are about one year of purchases. Based on these two statistics, the training period is set to 230 days by trial and error, which is about 4.3 times the sample mean. The rest of the time is in the validation set. 

Before fitting a model, the data should be pre-processed to match the format that the model is suitable for. In the raw data, each record represents a purchase, the three columns represent respectively the id of the customer that performs the purchase, the timestamp of that purchase and monetary value of that purchase. However, the pruchase count models are fit on RFM data, which is the short form for Recency(R), Frequency(F) and Monetary Value(M). The RFM data is indexed by customer ID. Each record contains the information of a customer. By tradition, Frequency is the number of repeat purchases a customer performs. For example, if a customer has in total performed 10 purchases, then the Frequency of that customer is 9, which is the total number of purchases minus 1. The Recency is the time difference between the first purchase and the last purchase of that customer. For example, if the first purchase is done on April 4th and the last on April 20th, then the Recency equals to 16, if measured by days. The Monetary Value is the average monetary value of the purchases done by that customer.

The purchase count and monetary value are modelled by two separate models. The purchase count models require that each record be in the format of (F,R,T), the meaning of F and R is defined above and T is the complete observation period of that customer, which equals to the time difference between the latest time in this dataset and the time of the first purchase. The following figure shows the snapshot of the raw data (left), the data ready for purchase count modeling (middle) and the data ready for purchase monetary value modeling (right).

//three_data_format


